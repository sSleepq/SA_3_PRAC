# **Лабораторная работа №13**
**Тема:** Конфигурация файлового хранилища с использованием RAID 0

## **Цель работы:**
Освоить практические навыки создания и настройки программного RAID-массива уровня 0 (stripe), включая создание разделов, форматирование и автоматическое монтирование файловой системы.

## **Теоретическая часть:**
**RAID 0 (striping)** - метод объединения нескольких физических дисков в один логический элемент для повышения производительности. Данные разделяются на блоки и записываются на все диски массива одновременно.

**Преимущества:**
- Увеличение скорости чтения/записи
- Полное использование дискового пространства

**Недостатки:**
- Отсутствие избыточности
- Выход из строя одного диска приводит к потере всех данных

## **Предварительные требования:**
На основе предыдущих лабораторных работ у нас настроена инфраструктура:
- **cus (Ubuntu Server 24.04):** DNS, DHCP, Samba DC (10.10.10.1)
- Доменная зона: `testdomen.local`

---

## **Ход работы:**

### **Часть 1: Подготовка виртуальных дисков**

1. **Добавление виртуальных дисков через гипервизор:**

   - Остановите виртуальную машину **cus**
   - В настройках VMWare добавьте два новых жестких диска по 1 ГБ каждый
   - Тип диска: SCSI, виртуальный диск как один файл
   - Запустите виртуальную машину

2. **Проверка обнаружения новых дисков в системе:**

   ```bash
   # Просмотр всех блочных устройств
   sudo lsblk
   
   # Детальная информация о дисках
   sudo fdisk -l
   
   # Проверка наличия новых дисков (sdb, sdc)
   ls -la /dev/sd*
   ```

   Вы должны увидеть примерно следующее:
   ```
   NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
   sda      8:0    0   20G  0 disk 
   ├─sda1   8:1    0    1M  0 part 
   ├─sda2   8:2    0  1.8G  0 part /boot
   └─sda3   8:3    0 18.2G  0 part /
   sdb      8:16   0    1G  0 disk 
   sdc      8:32   0    1G  0 disk 
   ```

### **Часть 2: Установка необходимых пакетов**

1. **Установка утилит для работы с RAID:**

   ```bash
   sudo apt update
   sudo apt install -y mdadm
   ```

2. **Проверка установки:**

   ```bash
   mdadm --version
   which mdadm
   ```

### **Часть 3: Создание разделов на дисках**

1. **Создание разделов на первом диске (/dev/sdb):**

   ```bash
   sudo fdisk /dev/sdb
   ```

   Последовательность команд в fdisk:
   ```
   n    # новый раздел
   p    # primary раздел
   1    # номер раздела
        # первый сектор (по умолчанию)
        # последний сектор (по умолчанию)
   t    # изменение типа раздела
   fd   # Linux raid auto
   p    # проверка созданного раздела
   w    # запись изменений и выход
   ```

2. **Создание разделов на втором диске (/dev/sdc):**

   ```bash
   sudo fdisk /dev/sdc
   ```

   Аналогичная последовательность команд.

3. **Проверка созданных разделов:**

   ```bash
   sudo lsblk
   sudo fdisk -l /dev/sdb
   sudo fdisk -l /dev/sdc
   ```

   Результат должен показывать:
   ```
   NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
   sdb      8:16   0    1G  0 disk 
   └─sdb1   8:17   0 1023M  0 part 
   sdc      8:32   0    1G  0 disk 
   └─sdc1   8:33   0 1023M  0 part 
   ```

### **Часть 4: Создание RAID 0 массива**

1. **Создание RAID массива уровня 0:**

   ```bash
   sudo mdadm --create --verbose /dev/md0 --level=0 --raid-devices=2 /dev/sdb1 /dev/sdc1
   ```

   Параметры команды:
   - `--create`: создать новый RAID массив
   - `--verbose`: подробный вывод
   - `/dev/md0`: имя RAID устройства
   - `--level=0`: уровень RAID 0
   - `--raid-devices=2`: количество дисков в массиве

2. **Проверка создания массива:**

   ```bash
   # Проверка статуса RAID
   cat /proc/mdstat
   
   # Детальная информация о массиве
   sudo mdadm --detail /dev/md0
   
   # Проверка блочных устройств
   sudo lsblk
   ```

   Ожидаемый вывод `cat /proc/mdstat`:
   ```
   Personalities : [linear] [multipath] [raid0] [raid1] [raid6] [raid5] [raid4] [raid10] 
   md0 : active raid0 sdc1[1] sdb1[0]
         2095104 blocks super 1.2 512k chunks
   ```

### **Часть 5: Сохранение конфигурации RAID**

1. **Сохранение конфигурации массива:**

   ```bash
   # Создание конфигурационного файла
   sudo mdadm --detail --scan | sudo tee -a /etc/mdadm/mdadm.conf
   
   # Обновление initramfs
   sudo update-initramfs -u
   ```

2. **Проверка конфигурационного файла:**

   ```bash
   sudo cat /etc/mdadm/mdadm.conf
   ```

### **Часть 6: Создание файловой системы**

1. **Форматирование RAID массива в ext4:**

   ```bash
   sudo mkfs.ext4 /dev/md0
   ```

2. **Проверка файловой системы:**

   ```bash
   sudo blkid /dev/md0
   sudo fsck.ext4 -f /dev/md0
   ```

### **Часть 7: Настройка автоматического монтирования**

1. **Создание точки монтирования:**

   ```bash
   sudo mkdir /raid
   
   # Проверка прав доступа
   ls -la / | grep raid
   ```

2. **Тестовое монтирование:**

   ```bash
   sudo mount /dev/md0 /raid
   
   # Проверка монтирования
   df -h /raid
   mount | grep md0
   ```

3. **Настройка автоматического монтирования через fstab:**

   ```bash
   # Получаем UUID RAID массива
   sudo blkid /dev/md0
   
   # Резервное копирование fstab
   sudo cp /etc/fstab /etc/fstab.backup
   
   # Добавляем запись в fstab
   echo "UUID=$(sudo blkid -s UUID -o value /dev/md0) /raid ext4 defaults 0 2" | sudo tee -a /etc/fstab
   ```

4. **Проверка корректности fstab:**

   ```bash
   # Проверка синтаксиса
   sudo findmnt --verify /raid
   
   # Тестовое монтирование
   sudo umount /raid
   sudo mount -a
   
   # Проверка
   df -h /raid
   ```

### **Часть 8: Тестирование работы RAID**

1. **Проверка доступного пространства:**

   ```bash
   df -h /raid
   
   # Должно показывать примерно 2ГБ
   ```

2. **Тест производительности записи:**

   ```bash
   sudo apt install -y hdparm
   
   # Тест скорости чтения
   sudo hdparm -Tt /dev/md0
   
   # Тест записи с помощью dd
   sudo dd if=/dev/zero of=/raid/testfile bs=1M count=500 oflag=direct
   ```

3. **Создание тестовых данных:**

   ```bash
   # Создание директорий
   sudo mkdir -p /raid/{documents,backups,shared}
   
   # Создание тестовых файлов
   sudo dd if=/dev/urandom of=/raid/test1.dat bs=1M count=100
   sudo dd if=/dev/urandom of=/raid/test2.dat bs=1M count=100
   
   # Проверка
   ls -lh /raid/
   df -h /raid
   ```

### **Часть 9: Настройка прав доступа**

1. **Настройка владельца и прав доступа:**

   ```bash
   # Изменение владельца
   sudo chown -R userx:root /raid/
   
   # Настройка прав
   sudo chmod -R 755 /raid/
   
   # Проверка
   ls -la /raid/
   ```

2. **Создание тестового файла для проверки:**

   ```bash
   echo "RAID 0 Storage Test - $(date)" | sudo tee /raid/raid_test.txt
   cat /raid/raid_test.txt
   ```

### **Часть 10: Интеграция с существующей инфраструктурой**

1. **Настройка общего доступа через Samba:**

   ```bash
   sudo nano /etc/samba/smb.conf
   ```

   Добавьте в конец файла:
   ```ini
   [raid-storage]
      path = /raid
      browseable = yes
      read only = no
      valid users = userx, webuser, webadmin
      create mask = 0775
      directory mask = 0775
   ```

2. **Перезагрузка Samba служб:**

   ```bash
   sudo systemctl restart smbd nmbd
   sudo systemctl status smbd
   ```

### **Часть 11: Проверка отказоустойчивости**

1. **Проверка статуса RAID после перезагрузки:**

   ```bash
   # Перезагрузка системы
   sudo reboot
   
   # После перезагрузки проверяем
   cat /proc/mdstat
   sudo mdadm --detail /dev/md0
   mount | grep raid
   df -h /raid
   ```

2. **Тестирование доступа к данным:**

   ```bash
   # Проверка существующих файлов
   ls -la /raid/
   cat /raid/raid_test.txt
   
   # Создание нового файла
   echo "Test after reboot - $(date)" >> /raid/raid_test.txt
   ```

### **Часть 12: Мониторинг и управление**

1. **Создание скрипта мониторинга RAID:**

   ```bash
   sudo nano /usr/local/bin/raid-status.sh
   ```

   ```bash
   #!/bin/bash
   echo "=== RAID Status Monitor ==="
   echo "RAID Array Status:"
   cat /proc/mdstat
   echo ""
   echo "Detailed Information:"
   sudo mdadm --detail /dev/md0
   echo ""
   echo "Disk Usage:"
   df -h /raid
   ```

   ```bash
   sudo chmod +x /usr/local/bin/raid-status.sh
   /usr/local/bin/raid-status.sh
   ```

2. **Добавление в cron для регулярной проверки:**

   ```bash
   sudo crontab -e
   ```

   Добавьте строку:
   ```
   # Ежедневная проверка RAID в 6:00
   0 6 * * * /usr/local/bin/raid-status.sh >> /var/log/raid-status.log
   ```

---

## **Контрольные вопросы:**

1. Какие преимущества и недостатки у RAID 0 по сравнению с другими уровнями RAID?
2. Почему при выходе из строя одного диска в RAID 0 теряются все данные?
3. Какую роль выполняет файл `/etc/mdadm/mdadm.conf`?
4. Почему важно обновлять initramfs после настройки RAID?
5. Какие команды используются для мониторинга состояния RAID массива?
6. Как обеспечить автоматическое монтирование RAID массива при загрузке системы?

---

## **Вывод:**
В ходе лабораторной работы была успешно настроена система файлового хранилища на основе RAID 0:

- Добавлены и настроены виртуальные диски через гипервизор
- Создан программный RAID 0 массив с использованием mdadm
- Настроена файловая система ext4 на RAID массиве
- Обеспечено автоматическое монтирование в директорию `/raid`
- Настроены права доступа и интеграция с Samba
- Реализован мониторинг состояния массива

Система обеспечивает повышенную производительность операций чтения/записи за счет распределения данных across двух дисков.