# **Лабораторная работа №12 (Могуть быть пролемы)**
**Тема:** Настройка аутентификации и авторизации на веб-сайтах

## **Цель работы:**
Освоить практические навыки настройки аутентификации и авторизации для веб-сайтов с использованием базовой HTTP-аутентификации, аутентификации через PAM и интеграции с доменной службой каталогов.

## **Теоретическая часть:**
**Аутентификация** - процесс проверки подлинности пользователя (кто вы?).
**Авторизация** - процесс проверки прав доступа пользователя (что вам разрешено?).

В данной работе будут рассмотрены:
1. Базовая HTTP-аутентификация (Basic Auth)
2. Аутентификация через PAM (Pluggable Authentication Modules)
3. Интеграция с доменной службой на базе Samba AD

## **Предварительные требования:**
На основе предыдущих лабораторных работ у нас настроена следующая инфраструктура:
- **cus (Ubuntu Server 24.04):** DNS (BIND9), DHCP, Samba DC
- **web1 (Debian 12):** Веб-сервер Apache2, VLAN 30 (10.10.30.10)
- **web2 (Debian 12):** Веб-сервер Apache2, VLAN 30 (10.10.30.11)
- **client1 (Debian 12):** Клиентская машина, VLAN 20 (10.10.20.50)

Доменная зона: `testdomen.local`

---

## **Ход работы:**

### **Часть 1: Подготовка пользователей в домене**

1. **Создание пользователей на контроллере домена (cus):**

   ```bash
   sudo samba-tool user create user1 --random-password --given-name=User1 --surname=Test
   sudo samba-tool user create user2 --random-password --given-name=User2 --surname=Test
   sudo samba-tool user create admin1 --random-password --given-name=Admin --surname=Test
   
   # Установка паролей вручную
   sudo samba-tool user setpassword user1
   sudo samba-tool user setpassword user2
   sudo samba-tool user setpassword admin1
   ```

2. **Создание групп и добавление пользователей:**

   ```bash
   sudo samba-tool group add web_users
   sudo samba-tool group add web_admins
   
   sudo samba-tool group addmembers web_users user1,user2
   sudo samba-tool group addmembers web_admins admin1
   ```

3. **Проверка создания пользователей:**

   ```bash
   sudo samba-tool user list
   sudo samba-tool group list
   wbinfo -u
   wbinfo -g
   ```

### **Часть 2: Настройка базовой HTTP-аутентификации на web1**

1. **Установка необходимых пакетов:**

   ```bash
   sudo apt update
   sudo apt install -y apache2-utils
   ```

2. **Создание файла с пользователями для базовой аутентификации:**

   ```bash
   sudo mkdir -p /etc/apache2/auth
   sudo htpasswd -c /etc/apache2/auth/basic_users user1
   sudo htpasswd /etc/apache2/auth/basic_users user2
   ```

3. **Создание защищенной директории и настройка аутентификации:**

   ```bash
   sudo mkdir -p /var/www/html/secure
   echo "<h1>Секретная страница с базовой аутентификацией</h1>" | sudo tee /var/www/html/secure/index.html
   ```

4. **Создание конфигурационного файла для защищенной директории:**

   ```bash
   sudo nano /etc/apache2/conf-available/basic-auth.conf
   ```

   ```apache
   <Directory "/var/www/html/secure">
       AuthType Basic
       AuthName "Restricted Area"
       AuthUserFile /etc/apache2/auth/basic_users
       Require valid-user
   </Directory>
   ```

5. **Активация конфигурации и перезагрузка Apache:**

   ```bash
   sudo a2enconf basic-auth
   sudo systemctl reload apache2
   ```

### **Часть 3: Настройка PAM-аутентификации на web2**

1. **Установка необходимых пакетов:**

   ```bash
   sudo apt update
   sudo apt install -y libapache2-mod-authnz-pam libpam-winbind
   ```

2. **Настройка PAM для работы с Winbind:**

   ```bash
   sudo nano /etc/pam.d/apache2
   ```

   ```bash
   #%PAM-1.0
   auth required pam_winbind.so
   account required pam_winbind.so
   ```

3. **Настройка Winbind для работы с доменом:**

   ```bash
   sudo nano /etc/nsswitch.conf
   ```

   Убедитесь, что строки содержат winbind:
   ```bash
   passwd: files systemd winbind
   group: files systemd winbind
   shadow: files winbind
   ```

4. **Настройка Kerberos:**

   ```bash
   sudo nano /etc/krb5.conf
   ```

   ```ini
   [libdefaults]
        default_realm = TESTDOMEN.LOCAL
        dns_lookup_realm = false
        dns_lookup_kdc = true

   [realms]
        TESTDOMEN.LOCAL = {
            kdc = cus.testdomen.local
            admin_server = cus.testdomen.local
        }

   [domain_realm]
        .testdomen.local = TESTDOMEN.LOCAL
        testdomen.local = TESTDOMEN.LOCAL
   ```

5. **Настройка Samba для аутентификации:**

   ```bash
   sudo nano /etc/samba/smb.conf
   ```

   ```ini
   [global]
        workgroup = TESTDOMEN
        realm = TESTDOMEN.LOCAL
        security = ads
        domain master = no
        local master = no
        preferred master = no
        idmap config * : backend = tdb
        idmap config * : range = 3000-7999
        winbind use default domain = yes
        winbind offline logon = false
        winbind enum users = yes
        winbind enum groups = yes
        template shell = /bin/bash
        template homedir = /home/%U
        password server = cus.testdomen.local
   ```

6. **Присоединение к домену:**

   ```bash
   # Остановите службы
   sudo systemctl stop winbind
   sudo systemctl stop smbd
   sudo systemctl stop nmbd
   
   # Присоединитесь к домену
   sudo net ads join -U administrator
   
   # Запустите службы
   sudo systemctl start winbind
   sudo systemctl enable winbind
   ```

7. **Проверка присоединения к домену:**

   ```bash
   sudo wbinfo -t
   sudo wbinfo -u
   sudo getent passwd user1
   ```

8. **Создание защищенной директории и настройка PAM-аутентификации:**

   ```bash
   sudo mkdir -p /var/www/html/pam-secure
   echo "<h1>Защищенная страница с PAM-аутентификацией через домен</h1>" | sudo tee /var/www/html/pam-secure/index.html
   ```

9. **Создание конфигурации Apache для PAM-аутентификации:**

   ```bash
   sudo nano /etc/apache2/conf-available/pam-auth.conf
   ```

   ```apache
   <Directory "/var/www/html/pam-secure">
       AuthType Basic
       AuthName "Domain Authentication"
       AuthBasicProvider PAM
       AuthPAMService apache2
       Require valid-user
   </Directory>
   ```

10. **Активация модулей и конфигурации:**

    ```bash
    sudo a2enmod authnz_pam
    sudo a2enconf pam-auth
    sudo systemctl reload apache2
    ```

### **Часть 4: Настройка авторизации по группам на web1**

1. **Создание дополнительной защищенной директории для администраторов:**

   ```bash
   sudo mkdir -p /var/www/html/admin
   echo "<h1>Административная панель - только для администраторов</h1>" | sudo tee /var/www/html/admin/index.html
   ```

2. **Создание файла с группами:**

   ```bash
   sudo nano /etc/apache2/auth/groups
   ```

   ```bash
   admins: admin1
   users: user1 user2
   ```

3. **Создание конфигурации для авторизации по группам:**

   ```bash
   sudo nano /etc/apache2/conf-available/group-auth.conf
   ```

   ```apache
   <Directory "/var/www/html/admin">
       AuthType Basic
       AuthName "Admin Area"
       AuthUserFile /etc/apache2/auth/basic_users
       AuthGroupFile /etc/apache2/auth/groups
       Require group admins
   </Directory>
   ```

4. **Активация конфигурации:**

   ```bash
   sudo a2enconf group-auth
   sudo systemctl reload apache2
   ```

### **Часть 5: Настройка SSL и защищенного доступа**

1. **Установка SSL-сертификатов (самоподписанных):**

   На web1 и web2:
   ```bash
   sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
     -keyout /etc/ssl/private/apache-selfsigned.key \
     -out /etc/ssl/certs/apache-selfsigned.crt \
     -subj "/C=RU/ST=Moscow/L=Moscow/O=TestDomen/CN=web1.testdomen.local"
   ```

2. **Настройка SSL виртуального хоста:**

   ```bash
   sudo nano /etc/apache2/sites-available/default-ssl.conf
   ```

   Обновите пути к сертификатам:
   ```apache
   SSLCertificateFile /etc/ssl/certs/apache-selfsigned.crt
   SSLCertificateKeyFile /etc/ssl/private/apache-selfsigned.key
   ```

3. **Активация SSL и перезагрузка:**

   ```bash
   sudo a2enmod ssl
   sudo a2ensite default-ssl
   sudo systemctl reload apache2
   ```

### **Часть 6: Тестирование аутентификации**

1. **Тестирование с клиентской машины (client1):**

   ```bash
   # Тестирование базовой аутентификации (web1)
   curl -u user1:password http://web1.testdomen.local/secure/
   
   # Тестирование PAM аутентификации (web2)
   curl -u user1:password http://web2.testdomen.local/pam-secure/
   
   # Тестирование групповой авторизации (web1)
   curl -u admin1:password http://web1.testdomen.local/admin/
   ```

2. **Тестирование через веб-браузер:**

   На client1 установите графический интерфейс или используйте текстовый браузер:
   ```bash
   sudo apt install -y lynx
   lynx http://web1.testdomen.local/secure/
   ```

3. **Проверка доступа с разными пользователями:**

   - user1 должен иметь доступ к `/secure/` и `/pam-secure/`, но не к `/admin/`
   - admin1 должен иметь доступ ко всем разделам

### **Часть 7: Настройка мониторинга и логирования**

1. **Настройка расширенного логирования аутентификации:**

   ```bash
   sudo nano /etc/apache2/conf-available/auth-logging.conf
   ```

   ```apache
   LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" AUTH:%{Authn-User}i" auth_combined
   CustomLog ${APACHE_LOG_DIR}/auth_access.log auth_combined
   ```

2. **Активация логирования:**

   ```bash
   sudo a2enconf auth-logging
   sudo systemctl reload apache2
   ```

3. **Просмотр логов аутентификации:**

   ```bash
   sudo tail -f /var/log/apache2/auth_access.log
   ```

---

## **Контрольные вопросы:**

1. В чем разница между аутентификацией и авторизацией?
2. Какие преимущества дает использование PAM-аутентификации по сравнению с базовой HTTP-аутентификацией?
3. Почему при использовании базовой аутентификации рекомендуется использовать HTTPS?
4. Как происходит процесс аутентификации через домен при использовании PAM и Winbind?
5. Какие меры безопасности следует предпринять при настройке аутентификации на веб-сервере?
6. Как можно ограничить доступ по IP-адресу в сочетании с аутентификацией?

---

## **Вывод:**
В ходе лабораторной работы были освоены различные методы аутентификации и авторизации на веб-серверах Apache:

- Настроена базовая HTTP-аутентификация с использованием файлов паролей
- Реализована PAM-аутентификация с интеграцией в домен Samba AD
- Настроена авторизация на основе групп пользователей
- Обеспечен защищенный доступ через SSL/TLS
- Настроено логирование событий аутентификации

Система обеспечивает гибкое управление доступом к веб-ресурсам с возможностью централизованного управления пользователями через доменную службу.