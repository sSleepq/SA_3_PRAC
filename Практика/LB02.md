# Лабораторная работа №2  
**Тема:** Настройка динамической сетевой трансляции портов (DNAT) для доступа к сети Интернет  
**Оборудование:** Ubuntu Server, Windows 10, гипервизор VMware Workstation  

## Цель работы  
Настроить динамическую трансляцию сетевых адресов (NAT) на сервере Ubuntu для обеспечения доступа в Интернет виртуальной машины с Windows 10 через общий внешний IP‑адрес.

## Исходные данные

- **Ubuntu Server** (роль: шлюз/маршрутизатор):  
  - Интерфейс `ens33` (NAT): динамический IP (DHCP)  
  - Интерфейс `ens34` (LAN Segment): `$10.10.13.1/24$`  
- **Windows 10** (клиент внутренней сети):  
  - Интерфейс (LAN Segment): `$10.10.13.x/24$` (где `x Любой адрес из подсети LAN сегмента Ubuntu server`, например `$10.10.13.2$`)  
  - Шлюз по умолчанию: `$10.10.13.1$`  
  - DNS: `$10.10.13.1$` или публичные DNS (`$8.8.8.8$`, `$8.8.4.4$`)

> **Примечание:** Имена интерфейсов (`ens33`, `ens34`) могут отличаться. Уточняйте их командой `ip a` на Ubuntu.

## Ход работы

### 1. Подготовка Ubuntu Server

#### 1.1. Включение маршрутизации

1. Откройте файл конфигурации ядра:  
   ```bash
   sudo nano /etc/sysctl.conf
   ```

2. Добавьте или активируйте строку:  
   ```
   net.ipv4.ip_forward=1
   ```

3. Примените изменения:  
   ```bash
   sudo sysctl -p
   ```

#### 1.2. Проверка текущих правил iptables

Выведите список правил:  
```bash
sudo iptables -L -n -v
sudo iptables -t nat -L -n -v
```

### 2. Настройка NAT (MASQUERADE)

1. Настройте маскарадинг для внешнего интерфейса (`ens33`):  
   ```bash
   sudo iptables -t nat -A POSTROUTING -o ens33 -j MASQUERADE
   ```

2. Разрешите транзитный трафик между интерфейсами:  
   ```bash
   sudo iptables -A FORWARD -i ens34 -o ens33 -j ACCEPT
   sudo iptables -A FORWARD -i ens33 -o ens34 -m state --state RELATED,ESTABLISHED -j ACCEPT
   ```

> **Важно:** Замените `ens33` и `ens34` на актуальные имена интерфейсов вашей системы.

### 3. Сохранение правил iptables

1. Установите пакет для сохранения правил:  
   ```bash
   sudo apt install iptables-persistent -y
   ```

2. Сохраните текущие правила:  
   ```bash
   sudo netfilter-persistent save
   sudo netfilter-persistent reload
   ```

### 4. Настройка DNS (опционально)

Для разрешения имён установите `dnsmasq`:  
```bash
sudo apt install dnsmasq -y
```

1. Отредактируйте конфигурацию:  
   ```bash
   sudo nano /etc/dnsmasq.conf
   ```

2. Добавьте строки:  
   ```
   interface=ens34
   listen-address=10.10.13.1
   server=8.8.8.8
   server=8.8.4.4
   ```

3. Запустите сервис:  
   ```bash
   sudo systemctl enable dnsmasq
   sudo systemctl start dnsmasq
   ```

### 5. Настройка Windows 10

1. Откройте **Панель управления** → **Сеть и Интернет** → **Центр управления сетями и общим доступом** → **Изменение параметров адаптера**.
2. В свойствах IPv4 укажите:  
   - IP‑адрес: `$10.10.13.2$` (или другой из подсети `$10.10.13.0/24$`, кроме `$10.10.13.1$`)  
   - Маска подсети: `$255.255.255.0$`  
   - Шлюз: `$10.10.13.1$`  
   - DNS: `$10.10.13.1$` (если установлен `dnsmasq`) или `$8.8.8.8$`  
3. Проверьте связь с шлюзом:  
   ```cmd
   ping 10.10.13.1
   ```

### 6. Проверка доступа в Интернет

#### 6.1. С Windows 10

1. Проверьте доступность внешнего IP:  
   ```cmd
   ping 8.8.8.8
   ```

2. Проверьте разрешение доменных имён:  
   ```cmd
   ping google.com
   ```

3. Откройте веб‑браузер и перейдите на любой сайт (например, `https://google.com`).

#### 6.2. С Ubuntu Server

1. Проверьте маршруты:  
   ```bash
   ip route
   ```

2. Проверьте NAT‑трансляции:  
   ```bash
   sudo iptables -t nat -L -n -v --line-numbers
   ```

3. Убедитесь, что трафик проходит через MASQUERADE:  
   ```bash
   sudo tcpdump -i ens33 -n port 80 or port 443
   ```

### 7. Дополнительная проверка (логирование)

1. Включите логирование транзитных пакетов:  
   ```bash
   sudo iptables -A FORWARD -j LOG --log-prefix "IPT-FORWARD: "
   ```

2. Просмотр логов:  
   ```bash
   sudo tail -f /var/log/syslog | grep IPT-FORWARD
   ```

## Результаты работы

1. На Ubuntu Server включена маршрутизация (`net.ipv4.ip_forward=1`).
2. Настроен MASQUERADE для трансляции адресов внутренней сети через внешний интерфейс.
3. Разрешён транзитный трафик между внутренним (`ens34`) и внешним (`ens33`) интерфейсами.
4. Правила iptables сохранены с помощью `iptables-persistent`.
5. На Windows 10 настроены статические параметры сети с указанием шлюза `$10.10.13.1$`.
6. Клиент Windows 10 имеет доступ в Интернет:
   - Успешные пинги до внешних IP (`8.8.8.8`).
   - Разрешение доменных имён (`google.com`).
   - Доступ к веб‑ресурсам через браузер.

## Выводы

В ходе лабораторной работы:
- Настроена динамическая трансляция сетевых адресов (NAT/MASQUERADE) на Ubuntu Server.
- Сервер Ubuntu успешно выполняет роль шлюза для виртуальной машины с Windows 10.
- Проверено прохождение трафика через NAT и разрешение DNS‑запросов.
- Освоены инструменты управления правилами iptables и их сохранения.
- Подтверждена работоспособность маршрутизации и трансляции адресов.

Работа выполнена успешно.
