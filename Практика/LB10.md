## Лабораторная работа: Настройка сервера балансировки нагрузки HAProxy

**Цель работы:** освоить принципы настройки и эксплуатации сервера балансировки нагрузки HAProxy в виртуальной среде; научиться распределять нагрузку между серверами с обеспечением отказоустойчивости.

### 1. Теоретическая часть

**HAProxy** (High Availability Proxy) — серверное программное обеспечение для обеспечения высокой доступности и балансировки нагрузки на TCP‑ и HTTP‑приложения посредством распределения запросов между несколькими серверами.

**Основные функции HAProxy:**
* балансировка нагрузки между серверами‑бэкендами;
* проверка доступности серверов (health checks);
* поддержка различных алгоритмов балансировки;
* SSL‑терминация;
* ведение логов и мониторинг.

### 2. Исходные данные и схема сети

**Используемая инфраструктура:**
* гипервизор: VMWare Workstation;
* виртуальные машины (ВМ):
  * **Ubuntu Server 24.04** (`cus.testdomen.local`):
    * 2 сетевых интерфейса: NAT (динамический), LAN‑сегмент (`10.10.13.1/24`);
    * предустановленное ПО: BIND9, isc‑dhcp‑server, SAMBA DC;
  * **Windows 10** (IP: динамический в `10.10.13.0/24`).

**Для выполнения работы требуется добавить 2 ВМ:**
* **Debian 13** (`web1.testdomen.local`, IP: `10.10.13.10`);
* **Debian 13** (`web2.testdomen.local`, IP: `10.10.13.11`).

**Схема сети:**
```
[Интернет] ↔ [NAT] ↔ [HAProxy (cus)] ↔ [LAN 10.10.13.0/24] ↔ [web1, web2, Windows 10]
```

### 3. Практическая часть

#### Шаг 1. Подготовка виртуальных машин web1 и web2

1. Создайте 2 новые ВМ с **Debian Server**.
2. Настройте сетевой интерфейс в LAN‑сегменте:
   * `web1`: статический IP `10.10.13.10`;
   * `web2`: статический IP `10.10.13.11`.
3. Установите веб‑сервер Apache:
   ```bash
   sudo apt update
   sudo apt install apache2 -y
   ```
4. Проверьте работу серверов: откройте в браузере `http://10.10.13.10` и `http://10.10.13.11` — должна отобразиться страница Apache по умолчанию.

#### Шаг 2. Установка HAProxy на сервере cus

1. Обновите список пакетов:
   ```bash
   sudo apt update
   ```
2. Установите HAProxy:
   ```bash
   sudo apt install haproxy -y
   ```
3. Проверьте статус:
   ```bash
   sudo systemctl status haproxy
   ```

#### Шаг 3. Настройка конфигурации HAProxy

1. Откройте конфигурационный файл:
   ```bash
   sudo nano /etc/haproxy/haproxy.cfg
   ```
2. Замените содержимое на следующую конфигурацию:

   ```cfg
   global
       log /dev/log local0
       log /dev/log local1 notice
       chroot /var/lib/haproxy
       stats socket /run/haproxy/admin.sock mode 660 level admin
       stats timeout 30s
       user haproxy
       group haproxy
       daemon

   defaults
       log global
       mode http
       option httplog
       option dontlognull
       timeout connect 5000
       timeout client  50000
       timeout server  50000

   frontend http_in
       bind *:80
       default_backend web_servers

   backend web_servers
       balance roundrobin
       server web1 10.10.13.10:80 check
       server web2 10.10.13.11:80 check

   listen stats
       bind *:8404
       stats enable
       stats uri /stats
       stats refresh 10s
       stats admin if TRUE
   ```

3. Сохраните файл (`Ctrl+O`, `Enter`, `Ctrl+X`).

#### Шаг 4. Проверка конфигурации и запуск HAProxy

1. Проверьте конфигурацию на ошибки:
   ```bash
   sudo haproxy -c -f /etc/haproxy/haproxy.cfg
   ```
2. Если ошибок нет, перезапустите сервис:
   ```bash
   sudo systemctl restart haproxy
   ```
3. Убедитесь, что сервис активен:
   ```bash
   sudo systemctl status haproxy
   ```

#### Шаг 5. Тестирование балансировки нагрузки

1. Откройте браузер и перейдите по адресу `http://10.10.13.1` — должен отобразиться сайт с одного из бэкенд‑серверов.
2. Обновите страницу несколько раз — при правильной настройке будет происходить чередование ответов от `web1` и `web2`.
3. Проверьте панель статистики HAProxy: `http://10.10.13.1:8404/stats` — там должны отображаться оба сервера и их статус.

#### Шаг 6. Проверка отказоустойчивости

1. Остановите веб‑сервер на `web1`:
   ```bash
   sudo systemctl stop apache2
   ```
2. Обновите страницу в браузере (`http://10.10.13.1`) — контент должен загружаться с `web2`.
3. Проверьте панель статистики — `web1` должен быть отмечен как `DOWN`.
4. Запустите Apache на `web1`:
   ```bash
   sudo systemctl start apache2
   ```
5. Через 10–15 секунд `web1` должен снова стать доступным в панели статистики.

### 4. Контрольные вопросы

1. Что такое HAProxy и для каких задач он применяется?
2. Какие алгоритмы балансировки нагрузки поддерживает HAProxy?
3. Как настроить проверку доступности бэкенд‑серверов в HAProxy?
4. В чём преимущество использования HAProxy перед прямым обращением к серверам?
5. Как можно расширить данную конфигурацию для работы с HTTPS?
6. В чём заключаются ключевые различия в администрировании Debian и Ubuntu при настройке веб‑серверов?
7. Какие особенности сетевой конфигурации Debian 12 следует учитывать при развёртывании в виртуальной среде?

### 5. Отчёт по работе

Отчёт должен содержать:
1. Цель работы.
2. Схему сети с указанием IP‑адресов всех узлов.
3. Ключевые команды, выполненные в процессе настройки.
4. Скриншоты:
   * панели статистики HAProxy;
   * результатов тестирования балансировки (чередование ответов от web1 и web2);
   * проверки отказоустойчивости (статус DOWN для web1).
5. Ответы на контрольные вопросы.
6. Выводы по работе (что удалось настроить, с какими сложностями столкнулись, возможные пути оптимизации).

### 6. Требования к выполнению

1. Все команды выполнять с правами суперпользователя (`sudo`).
2. Конфигурационные файлы редактировать только через `nano` или `vim`.
3. Перед каждым перезапуском сервиса проверять конфигурацию командой `haproxy -c`.
4. При установке ПО в Debian использовать официальный репозиторий.
5. Убедиться, что в Debian службы запускаются автоматически после перезагрузки (`sudo systemctl enable apache2`, `sudo systemctl enable haproxy`).
