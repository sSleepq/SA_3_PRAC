# **Лабораторная работа №11**
**Тема:** Настройка виртуальных локальных сетей (VLAN) в сетевой инфраструктуре на основе Debian-серверов

## **Цель работы:**
Приобрести практические навыки по настройке VLAN на маршрутизирующем сетевом интерфейсе для логического разделения сети и управления сетевым трафиком между виртуальными машинами на базе Debian, включая комплексную настройку сопутствующих служб (DHCP, DNS).

## **Теоретическая часть:**
Виртуальная локальная сеть (VLAN) — это логическая группа устройств, которая функционирует как отдельная сеть, независимо от физического расположения устройств. VLAN позволяют сегментировать сеть для повышения безопасности, производительности и управляемости. Маршрутизация между VLAN (Inter-VLAN Routing) требуется для того, чтобы хосты из разных VLAN могли обмениваться данными.

В данной работе в качестве маршрутизатора будет выступать виртуальная машина **cus (Ubuntu Server)**.

## **Исходная конфигурация:**
- **Гипервизор:** VMWare Workstation
- **Виртуальные машины (только Debian/Ubuntu):**
  - **cus (Ubuntu Server 24.04):**
    - Сетевые интерфейсы: `ens33` (NAT, динамический), `ens37` (LAN Segment, `10.10.13.1/24`)
    - Роли: BIND9 (DNS), isc-dhcp-server, SAMBA DC, HAProxy
  - **web1 (Debian 12):** Статический IP-адрес `10.10.13.10`
  - **web2 (Debian 12):** Статический IP-адрес `10.10.13.11`
  - **client1 (Debian 12):** Получает IP-адрес по DHCP

## **Задача:**
Провести логическое разделение сети на три VLAN:
- **VLAN 10 (Сеть управления):** `10.10.10.0/24`
  - В этой сети должны находиться серверы и административные рабочие станции
- **VLAN 20 (Пользовательская сеть):** `10.10.20.0/24`
  - В этой сети должны находиться обычные пользовательские рабочие станции
- **VLAN 30 (Серверная сеть):** `10.10.30.0/24`
  - В этой сети должны находиться веб-серверы

**Распределение устройств:**
- **cus:** VLAN 10 (управление) + маршрутизация между VLAN
- **web1, web2:** VLAN 30 (серверная сеть)
- **client1:** VLAN 20 (пользовательская сеть)

**Важное ограничение:** Студенты не могут создавать новые виртуальные коммутаторы в VMWare Workstation. Вся настройка должна быть выполнена на уровне гостевых ОС, используя существующие подключения к LAN Segment.

---

## **Ход работы:**

### **Часть 1: Подготовка виртуальных машин к работе с VLAN**

1. **Настройка сетевых адаптеров в VMWare:**
   - Для всех четырех виртуальных машин (cus, web1, web2, client1) убедитесь, что их единственный адаптер в "LAN Segment" подключен к **одному и тому же** виртуальному LAN Segment

2. **Установка необходимых пакетов на все машины:**
   ```bash
   sudo apt update && sudo apt install -y vlan
   ```
   - Проверьте загрузку модуля ядра:
   ```bash
   lsmod | grep 8021q
   ```
   - Если модуль не загружен:
   ```bash
   sudo modprobe 8021q
   echo '8021q' | sudo tee -a /etc/modules
   ```

### **Часть 2: Настройка VLAN на маршрутизаторе (cus - Ubuntu Server)**

**Для Ubuntu Server используем Netplan:**

1. **Создайте конфигурационный файл Netplan** (`/etc/netplan/01-netcfg.yaml`):

```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    ens33:
      dhcp4: true
    ens37:
      dhcp4: no
      addresses: []
  vlans:
    vlan10:
      id: 10
      link: ens37
      addresses: [10.10.10.1/24]
    vlan20:
      id: 20
      link: ens37
      addresses: [10.10.20.1/24]
    vlan30:
      id: 30
      link: ens37
      addresses: [10.10.30.1/24]
```

2. **Примените новые настройки Netplan:**
   ```bash
   sudo netplan apply
   ```

3. **Проверьте созданные VLAN-интерфейсы:**
   ```bash
   ip addr show | grep vlan
   ```

### **Часть 3: Настройка DHCP-сервера для работы с несколькими VLAN**

1. **Изменение конфигурации DHCP-сервера** (`/etc/dhcp/dhcpd.conf`):

```bash
# Конфигурация для VLAN 10 (Управление)
subnet 10.10.10.0 netmask 255.255.255.0 {
  range 10.10.10.50 10.10.10.100;
  option routers 10.10.10.1;
  option domain-name-servers 10.10.10.1;
  option domain-name "testdomen.local";
}

# Конфигурация для VLAN 20 (Пользователи)
subnet 10.10.20.0 netmask 255.255.255.0 {
  range 10.10.20.50 10.10.20.100;
  option routers 10.10.20.1;
  option domain-name-servers 10.10.10.1;
  option domain-name "testdomen.local";
}

# Конфигурация для VLAN 30 (Серверы)
subnet 10.10.30.0 netmask 255.255.255.0 {
  range 10.10.30.50 10.10.30.100;
  option routers 10.10.30.1;
  option domain-name-servers 10.10.10.1;
  option domain-name "testdomen.local";
}
```

2. **Настройка интерфейсов в файле** `/etc/default/isc-dhcp-server`:
```bash
INTERFACESv4="vlan10 vlan20 vlan30"
INTERFACESv6=""
```

3. **Перезапустите службу DHCP-сервера:**
   ```bash
   sudo systemctl restart isc-dhcp-server
   sudo systemctl status isc-dhcp-server
   ```

### **Часть 4: Настройка веб-серверов (web1, web2) в VLAN 30**

1. **Настройка сети на web1 через /etc/network/interfaces:**

   ```bash
   sudo nano /etc/network/interfaces
   ```

   ```bash
   # Файл /etc/network/interfaces на web1
   source /etc/network/interfaces.d/*

   # The loopback network interface
   auto lo
   iface lo inet loopback

   # Физический интерфейс
   auto eth0
   iface eth0 inet manual

   # VLAN 30
   auto eth0.30
   iface eth0.30 inet static
     address 10.10.30.10
     netmask 255.255.255.0
     gateway 10.10.30.1
     dns-nameservers 10.10.10.1
     dns-search testdomen.local
     vlan-raw-device eth0
   ```

2. **Настройка сети на web2:**

   ```bash
   sudo nano /etc/network/interfaces
   ```

   ```bash
   # Файл /etc/network/interfaces на web2
   source /etc/network/interfaces.d/*

   auto lo
   iface lo inet loopback

   auto eth0
   iface eth0 inet manual

   auto eth0.30
   iface eth0.30 inet static
     address 10.10.30.11
     netmask 255.255.255.0
     gateway 10.10.30.1
     dns-nameservers 10.10.10.1
     dns-search testdomen.local
     vlan-raw-device eth0
   ```

3. **Перезапустите сеть на обоих серверах:**
   ```bash
   sudo systemctl restart networking
   ```

4. **Проверка сети:**
   ```bash
   ip addr show eth0.30
   ping 10.10.30.1
   ```

5. **Установите и настройте Apache на веб-серверах:**
   ```bash
   sudo apt install -y apache2
   echo "<h1>Web1 - VLAN 30 - 10.10.30.10</h1>" | sudo tee /var/www/html/index.html
   # На web2:
   echo "<h1>Web2 - VLAN 30 - 10.10.30.11</h1>" | sudo tee /var/www/html/index.html
   ```

### **Часть 5: Настройка клиента (client1) в VLAN 20**

1. **Настройка сети на client1 через /etc/network/interfaces:**

   ```bash
   sudo nano /etc/network/interfaces
   ```

   ```bash
   # Файл /etc/network/interfaces на client1
   source /etc/network/interfaces.d/*

   auto lo
   iface lo inet loopback

   auto eth0
   iface eth0 inet manual

   auto eth0.20
   iface eth0.20 inet dhcp
     dns-nameservers 10.10.10.1
     dns-search testdomen.local
     vlan-raw-device eth0
   ```

2. **Перезапустите сеть:**
   ```bash
   sudo systemctl restart networking
   ```

3. **Проверьте получение IP-адреса:**
   ```bash
   ip addr show eth0.20
   dhclient -v eth0.20
   ```

### **Часть 6: Реконфигурация BIND9 для работы с VLAN**

1. **Обновление прямой зоны** (`/etc/bind/db.testdomen.local`):

```bash
;
; BIND data file for testdomen.local
;
$TTL    604800
@       IN      SOA     cus.testdomen.local. admin.testdomen.local. (
                          2024052001 ; Serial
                          604800     ; Refresh
                           86400     ; Retry
                         2419200     ; Expire
                          604800 )   ; Negative Cache TTL
;
; NS records
@       IN      NS      cus.testdomen.local.

; A records for VLAN 10 (Management)
cus     IN      A       10.10.10.1

; A records for VLAN 20 (Users)
client1 IN      A       10.10.20.50

; A records for VLAN 30 (Servers)
web1    IN      A       10.10.30.10
web2    IN      A       10.10.30.11

; CNAME records
www1    IN      CNAME   web1
www2    IN      CNAME   web2
```

2. **Добавление обратных зон** в `/etc/bind/named.conf.local`:

```bash
// Reverse zone for VLAN 10 (10.10.10.0/24)
zone "10.10.10.in-addr.arpa" {
    type master;
    file "/etc/bind/db.10.10.10";
};

// Reverse zone for VLAN 20 (10.10.20.0/24)  
zone "20.10.10.in-addr.arpa" {
    type master;
    file "/etc/bind/db.10.10.20";
};

// Reverse zone for VLAN 30 (10.10.30.0/24)
zone "30.10.10.in-addr.arpa" {
    type master;
    file "/etc/bind/db.10.10.30";
};
```

3. **Создание файлов обратных зон:**

   Файл `/etc/bind/db.10.10.10`:
```bash
;
; Reverse zone for VLAN 10
;
$TTL    604800
@       IN      SOA     cus.testdomen.local. admin.testdomen.local. (
                          2024052001 ; Serial
                          604800     ; Refresh
                           86400     ; Retry
                         2419200     ; Expire
                          604800 )   ; Negative Cache TTL
@       IN      NS      cus.testdomen.local.
1       IN      PTR     cus.testdomen.local.
```

   Файл `/etc/bind/db.10.10.20`:
```bash
;
; Reverse zone for VLAN 20
;
$TTL    604800
@       IN      SOA     cus.testdomen.local. admin.testdomen.local. (
                          2024052001 ; Serial
                          604800     ; Refresh
                           86400     ; Retry
                         2419200     ; Expire
                          604800 )   ; Negative Cache TTL
@       IN      NS      cus.testdomen.local.
50      IN      PTR     client1.testdomen.local.
```

   Файл `/etc/bind/db.10.10.30`:
```bash
;
; Reverse zone for VLAN 30
;
$TTL    604800
@       IN      SOA     cus.testdomen.local. admin.testdomen.local. (
                          2024052001 ; Serial
                          604800     ; Refresh
                           86400     ; Retry
                         2419200     ; Expire
                          604800 )   ; Negative Cache TTL
@       IN      NS      cus.testdomen.local.
10      IN      PTR     web1.testdomen.local.
11      IN      PTR     web2.testdomen.local.
```

4. **Настройка ACL в** `/etc/bind/named.conf.options`:

```bash
acl "trusted-networks" {
     10.10.10.0/24;    # VLAN 10
     10.10.20.0/24;    # VLAN 20
     10.10.30.0/24;    # VLAN 30
     127.0.0.1;        # localhost
};

options {
     directory "/var/cache/bind";
     allow-query { trusted-networks; };
     allow-recursion { trusted-networks; };
     allow-query-cache { trusted-networks; };
     
     forwarders {
         8.8.8.8;
         1.1.1.1;
     };
     
     dnssec-validation auto;
     listen-on { any; };
     listen-on-v6 { any; };
};
```

5. **Проверка и перезагрузка BIND9:**
   ```bash
   sudo named-checkconf
   sudo named-checkzone testdomen.local /etc/bind/db.testdomen.local
   sudo systemctl restart bind9
   sudo systemctl status bind9
   ```

### **Часть 8: Востановите работоспособность HAProxy под новые IP**

1. **Проверка связи с client1 (VLAN 20):**
   ```bash
   # Проверка IP-адреса
   ip addr show eth0.20
   
   # Проверка маршрутизации
   ip route
   
   # Проверка связи с другими VLAN
   ping 10.10.10.1    # Шлюз VLAN 10
   ping 10.10.20.1    # Свой шлюз
   ping 10.10.30.1    # Шлюз VLAN 30
   ping 10.10.30.10   # web1
   ping 10.10.30.11   # web2
   ```

2. **Проверка работы веб-серверов с client1:**
   ```bash
   curl http://10.10.30.10
   curl http://10.10.30.11
   curl http://web1.testdomen.local
   curl http://web2.testdomen.local
   ```

3. **Проверка разрешения имен:**
   ```bash
   nslookup web1.testdomen.local
   nslookup web2.testdomen.local
   nslookup client1.testdomen.local
   nslookup cus.testdomen.local
   
   # Обратное разрешение
   nslookup 10.10.30.10
   nslookup 10.10.30.11
   nslookup 10.10.20.50
   ```

4. **Проверка маршрутизации на cus:**
   ```bash
   # Проверка таблицы маршрутизации
   ip route show
   
   # Проверка VLAN интерфейсов
   ip -d link show type vlan
   ```

---



## **Контрольные вопросы:**

1. Объясните принцип работы VLAN и почему устройства в разных VLAN не могут общаться без маршрутизатора?
2. Какую роль выполняет тег VLAN (VLAN ID) в сетевых пакетах?
3. Почему в настройках DHCP-сервера необходимо указывать VLAN-интерфейсы, а не физический интерфейс?
4. Какие преимущества дает разделение сети на VLAN с точки зрения безопасности?
5. Как происходит маршрутизация между разными VLAN на сервере cus?
6. Почему для каждой VLAN требуется отдельная обратная DNS-зона?

---

## **Вывод:**
В ходе лабораторной работы была успешно реализована комплексная настройка сетевой инфраструктуры с разделением на три VLAN с использованием только Debian-серверов. Были выполнены следующие задачи:

- Настройка VLAN-интерфейсов и маршрутизации между VLAN на сервере cus (используя Netplan)
- Настройка VLAN на Debian-серверах через файл `/etc/network/interfaces`
- Адаптация DHCP-сервера для работы с несколькими подсетями
- Настройка веб-серверов в отдельной серверной VLAN
- Конфигурация клиентской машины с автоматическим получением IP-адреса
- Полная реконфигурация DNS-сервера BIND9 с созданием прямых и обратных зон для всех VLAN

Система обеспечивает корректное разрешение имен, маршрутизацию между логически разделенными сегментами сети и изоляцию трафика, что подтверждено тестированием связности и работы сетевых служб.